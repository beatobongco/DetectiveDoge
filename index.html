<!DOCTYPE html>
<html>
<head>
  <title>Detective Doge</title>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PreloadJS/0.6.0/preloadjs.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.4/vue.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
  <div class="app">
    <div v-if="!isLoaded">Loading... {{progress}}%</div>
    <div class="game" v-if="isLoaded">
      <div class="hud">
        <div class="level">Threat level: {{ level }}</div>
        <div class="score">Score: {{score}} </div>
      </div>
      <div class="warning-system">
        <div class="warning duck" v-show="hint === 'duck'">&darr;</div>
        <div class="warning left" v-show="hint === 'left'">&larr;</div>
        <div class="warning right" v-show="hint === 'right'">&rarr;</div>
      </div>
      <div class="powerup-container">
        <div class="powerup duck" v-show="powerUpLocation === 'duck'">&clubs;</div>
        <div class="powerup left" v-show="powerUpLocation === 'left'">&clubs;</div>
        <div class="powerup right" v-show="powerUpLocation === 'right'">&clubs;</div>
      </div>
      <div class="detective dead" v-show="detectiveState === 'dead'">You died. Press "r" to restart.</div>
      <div class="detective stand" v-show="detectiveState === 'stand'"></div>
      <div class="detective duck" v-show="detectiveState === 'duck'"></div>
      <div class="detective left" v-show="detectiveState === 'left'"></div>
      <div class="detective right" v-show="detectiveState === 'right'"></div>
    </div>
  </div>
  <script type="text/javascript">
    /*
      As more mob members arrive
      Have powerups that decrease the level.
      Mob psycho reference % to mob's explosion
      maybe like threat level
    */

    //constants
    var startingSpeed = 750
    var speedDecrement = 50

    var app = new Vue({
      el: '.app',
      data: {
        isLoaded: false,
        progress: 0,
        level: 1,
        score: 0,
        detectiveState: "stand",
        hint: "",
        counter: 0,
        lastShot: "",
        powerUpLocation: "",
      },
      watch: {
        detectiveState: function(val) {
          if (val === this.powerUpLocation) {
            var pistolSound = new Audio('sound/pistol.mp3')
            pistolSound.play()
            setTimeout(function() {
              var screamSound = new Audio("sound/wilhelm.mp3")
              screamSound.play()
            }, 100)
            this.score += 5
            this.powerUpLocation = ""
            this.level--
          }
        }
      },
    })

    //preload
    var queue = new createjs.LoadQueue(true)
    queue.on("complete", handleComplete)
    queue.on("progress", handleProgress)
    queue.loadFile('sound/fast_talkin.mp3')
    queue.loadFile('sound/whoosh.mp3')
    queue.loadFile('sound/pistol.mp3')
    queue.loadFile('sound/wilhelm.mp3')
    queue.loadFile('sound/woof.mp3')
    queue.loadFile('sound/machine_gun.mp3')

    var gameLoop = null
    var bgm = new Audio("sound/fast_talkin.mp3")
    var whooshSound = new Audio("sound/whoosh.mp3")

    function handleProgress(e) {
      console.log(e)
      app.progress = Math.floor(e.progress * 100)
    }

    function handleComplete() {
      console.log("Loaded")
      app.isLoaded = true
    }


    //handle swipes
    var hammertime = new Hammer(document.querySelector(".app"))

    hammertime.on('tap', function(e) {
      if (app.detectiveState === "dead") {
        resetGame()
      }
    })

    function setupTouch() {
      hammertime.get('swipe').set({ direction: Hammer.DIRECTION_ALL })
      hammertime.on('swipeleft', function(e) {
        app.detectiveState = "left"
        whooshSound.play()
      })
      hammertime.on('swiperight', function(e) {
        app.detectiveState = "right"
        whooshSound.play()
      })
      hammertime.on('swipeup', function(e) {
        app.detectiveState = "stand"
        whooshSound.play()
      })
      hammertime.on('swipedown', function(e) {
        app.detectiveState = "duck"
        whooshSound.play()
      })
    }

    function checkKey(e) {
      e = e || window.event
      if (e.keyCode == '38') {
        app.detectiveState = "stand"
        whooshSound.play()
      }
      else if (e.keyCode == '40') {
        app.detectiveState = "duck"
        whooshSound.play()
      }
      else if (e.keyCode == '37') {
        app.detectiveState = "left"
        whooshSound.play()
      }
      else if (e.keyCode == '39') {
        app.detectiveState = "right"
        whooshSound.play()
      }
    }

    function resetGame() {
      app.level = 1
      app.score = 0
      app.detectiveState = "stand"
      app.hint = ""
      app.counter = 0
      app.lastShot = ""
      app.powerUpLocation = ""
      startGame()
    }

    function checkReset(e) {
      e = e || window.event
      if (e.keyCode == '82') {
        resetGame()
      }
    }

    function randomChoice(arr) {
      return arr[Math.floor(arr.length * Math.random())];
    }

    function gameOver() {
      var deathSound = new Audio("sound/death.mp3")
      deathSound.play()
      app.detectiveState = "dead"
      app.powerUpLocation = ""
      app.hint = ""
      hammertime.off("swipeleft swipedown swipeup swiperight")
      clearInterval(gameLoop)
      document.onkeydown = checkReset
      bgm.pause()
    }

    function shootDetective() {
      var shotChoices = ["duck", "left", "right"]
      var index = shotChoices.indexOf(app.lastShot)

      if (index > -1) {
        shotChoices.splice(index, 1)
      }

      var aliveChoice = randomChoice(shotChoices)

      app.lastShot = aliveChoice
      app.hint = aliveChoice

      var hintSound = new Audio('sound/woof.mp3')
      hintSound.play()

      //10% chance to spawn powerup
      if (app.level > 1 && Math.random() < 0.1) {
        shotChoices.push("stand")
        app.powerUpLocation = randomChoice(shotChoices)
      }

      setTimeout(function() {
        var mgSound = new Audio("sound/machine_gun.mp3")
        mgSound.volume = 0.25
        mgSound.play()
        if (app.detectiveState === aliveChoice) {
          app.powerUpLocation = ""
          app.score += app.level
          app.counter++

          if (app.counter % 5 === 0) {
            app.level++
          }
        }
        else {
          gameOver()
        }
      }, startingSpeed - (app.level * speedDecrement))
    }

    function startGame() {
      gameLoop = setInterval(shootDetective, (startingSpeed + 500) - (app.level * speedDecrement))

      document.onkeydown = checkKey
      setupTouch()
      bgm.play()
    }

    startGame()

  </script>
</body>
</html>
